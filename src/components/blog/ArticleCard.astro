---
// filepath: src/components/blog/ArticleCard.astro
import { Badge } from '@components/starwind/badge';
import { Avatar, AvatarImage, AvatarFallback } from '@components/starwind/avatar';
import { Button } from '@components/starwind/button';
import { Icon } from 'astro-icon/components';

interface Props {
  article: {
    id?: string;
    article_title: string;
    article_summary?: string;
    article_featured_image_url?: string | null;
    article_featured_image_alt?: string | null;
    article_seo_slug: string;
    publication_date?: string;
    read_time_minutes?: number;
    view_count?: number;
    author_name?: string;
    author_profile_image_url?: string | null;
    author_bio?: string | null;
    category_name?: string;
    category_seo_slug: string;
    category_icon_name?: string | null;
  };
  lang: string;
  magazineSlug: string;
  variantData: 'full' | 'recent' | 'popular' | 'minimal' | 'related';
  variantStyle: 'featured' | 'horizontal' | 'compact' | 'simple';
}

const { article, lang, magazineSlug, variantData, variantStyle } = Astro.props;

const translations = {
  fr: {
    featured: 'À la une',
    read: "Lire l'article",
    noAuthor: 'Rédacteur',
    share: "Partager l'article",
    min: 'min',
    views: 'vues',
    noArticles: "Aucun article pour le moment.",
  },
  en: {
    featured: 'Featured',
    read: 'Read article',
    noAuthor: 'Author',
    share: 'Share article',
    min: 'min',
    views: 'views',
    noArticles: "No articles yet.",
  },
  es: {
    featured: 'Destacado',
    read: 'Leer el artículo',
    noAuthor: 'Autor',
    share: 'Compartir el artículo',
    min: 'min',
    views: 'vistas',
    noArticles: "Ningún artículo por ahora.",
  }
};
const t = translations[lang] ?? translations.fr;

const articleUrl = `/${lang}/${magazineSlug}/${article.category_seo_slug}/${article.article_seo_slug}`;
const defaultImage = `https://placehold.co/800x500/e2e8f0/64748b?text=${article.category_icon_name ? article.category_icon_name.replace('openmoji:', '').replace(/-/g, ' ') : 'Article'}`;
const formatDate = (dateString?: string) => dateString ? new Date(dateString).toLocaleDateString(lang, { day: 'numeric', month: 'long', year: 'numeric' }) : '';
---

<article class={`
  bg-white rounded-lg border border-gray-100
  ${variantStyle === 'featured' ? 'overflow-hidden flex flex-col group shadow-sm' : ''}
  ${variantStyle === 'horizontal' ? 'p-4 flex flex-col md:flex-row gap-6 items-center group shadow-sm' : ''}
  ${variantStyle === 'compact' ? 'flex gap-4 items-start' : ''}
  ${variantStyle === 'simple' ? 'p-4 shadow-sm hover:shadow-md transition-shadow' : ''}
`}>
  {/* Image Section */}
  {(variantStyle === 'featured' || variantStyle === 'horizontal' || variantStyle === 'compact') && (
    <a href={articleUrl} class={`
      ${variantStyle === 'featured' ? 'block' : ''}
      ${variantStyle === 'horizontal' ? 'block shrink-0 w-full md:w-auto' : ''}
      ${variantStyle === 'compact' ? 'w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center shrink-0 overflow-hidden' : ''}
    `}>
      <div class={`
        ${variantStyle === 'featured' ? 'relative w-full h-56' : ''}
        ${variantStyle === 'horizontal' ? 'w-full h-40 md:w-32 md:h-32 bg-gray-100 rounded-xl flex items-center justify-center overflow-hidden' : ''}
        ${variantStyle === 'compact' ? 'w-full h-full' : ''}
      `}>
        {article.article_featured_image_url ? (
          <img
            src={article.article_featured_image_url}
            alt={article.article_featured_image_alt || `${article.article_title}`}
            class={`
              ${variantStyle === 'featured' ? 'w-full h-full object-cover transition-transform duration-300 group-hover:scale-105' : ''}
              ${variantStyle === 'horizontal' ? 'w-full h-full object-cover' : ''}
              ${variantStyle === 'compact' ? 'w-full h-full object-cover rounded-lg' : ''}
            `}
            loading="lazy"
          />
        ) : (
          <Icon name={article.category_icon_name || 'openmoji:newspaper'} class={`
            ${variantStyle === 'featured' ? 'h-24 w-24 text-gray-300' : ''}
            ${variantStyle === 'horizontal' ? 'h-16 w-16 text-gray-300' : ''}
            ${variantStyle === 'compact' ? 'h-8 w-8 text-gray-300' : ''}
          `} />
        )}
        {variantStyle === 'featured' && (
          <div class="absolute top-4 left-4 flex flex-wrap mr-2 gap-2">
            <Badge variant="primary" size='sm' class="rounded">{t.featured}</Badge>
            {article.category_name && <Badge variant="secondary" size='sm' class="rounded">{article.category_name}</Badge>}
          </div>
        )}
      </div>
    </a>
  )}

  {/* Content Section */}
  <div class={`
    ${variantStyle === 'featured' ? 'p-6 flex-grow flex flex-col' : ''}
    ${variantStyle === 'horizontal' ? 'flex-grow w-full' : ''}
    ${variantStyle === 'compact' ? '' : ''}
    ${variantStyle === 'simple' ? '' : ''}
  `}>
    {variantStyle === 'horizontal' && article.category_name && <Badge class="mb-2">{article.category_name}</Badge>}
    <h3 class={`
      font-bold text-gray-800
      ${variantStyle === 'featured' ? 'text-xl mb-2' : ''}
      ${variantStyle === 'horizontal' ? 'text-lg mb-2' : ''}
      ${variantStyle === 'compact' ? 'text-sm line-clamp-2 leading-tight' : ''}
      ${variantStyle === 'simple' ? 'text-base' : ''}
    `}>
      <a href={articleUrl} class="hover:text-blue-600 transition-colors">{article.article_title}</a>
    </h3>

    {(variantData === 'full' || variantData === 'recent') && (
      <p class={`
        text-gray-600 mb-4
        ${variantStyle === 'featured' ? 'flex-grow line-clamp-3' : 'text-sm line-clamp-2'}
      `}>
        {article.article_summary}
      </p>
    )}

    {variantData === 'full' && (
      <div class="flex items-center text-sm text-gray-500 mb-6">
        <Avatar>
          <AvatarImage src={article.author_profile_image_url} alt={article.author_name} />
          <AvatarFallback>{article.author_name?.split(' ').map(n => n[0]).join('') || 'N/A'}</AvatarFallback>
        </Avatar>
        <div>
          <p class="font-semibold text-gray-700">{article.author_name}</p>
          <p class="text-xs text-gray-600">{article.author_bio ? article.author_bio.split('.')[0] : t.noAuthor}</p>
        </div>
      </div>
    )}

    {(variantData === 'full' || variantData === 'recent' || variantData === 'popular') && (
      <div class={`
        ${variantStyle === 'featured' ? 'border-t border-gray-100 pt-4 flex items-center justify-between text-sm text-gray-500' : ''}
        ${variantStyle === 'horizontal' ? 'flex flex-col sm:flex-row items-start sm:items-center justify-between text-sm text-gray-500 gap-4' : ''}
        ${variantStyle === 'compact' ? 'flex items-center gap-3 text-xs text-gray-500 mt-1' : ''}
      `}>
        {variantData === 'recent' && (
          <div class="flex items-center gap-3">
            <Avatar class="h-6 w-6">
              <AvatarImage src={article.author_profile_image_url} alt={article.author_name} inferSize={true} />
              <AvatarFallback>{article.author_name?.split(' ').map(n => n[0]).join('') || 'N/A'}</AvatarFallback>
            </Avatar>
            <span class="font-medium">{article.author_name}</span>
            <span class="hidden md:inline">•</span>
            <span class="hidden md:inline">{formatDate(article.publication_date)}</span>
          </div>
        )}
        {variantData === 'full' && (
          <div class="flex items-center gap-4">
            <span class="flex items-center gap-1.5"><Icon name="openmoji:calendar" class="h-4 w-4" /> {formatDate(article.publication_date)}</span>
            <span class="flex items-center gap-1.5"><Icon name="openmoji:stopwatch" class="h-4 w-4" /> {article.read_time_minutes} {t.min}</span>
          </div>
        )}
        {(variantData === 'full' || variantData === 'popular') && article.view_count !== undefined && (
          <div class="flex items-center gap-4">
            <span class="flex items-center gap-1.5"><Icon name="openmoji:eye" class="h-4 w-4" /> {article.view_count} {t.views}</span>
          </div>
        )}
        {variantData === 'recent' && (
          <div class="flex items-center gap-3 self-end sm:self-center">
            <span class="flex items-center gap-1.5"><Icon name="openmoji:stopwatch" class="h-4 w-4" /> {article.read_time_minutes} {t.min}</span>
            <button class="hover:text-blue-600 p-1 -m-1" aria-label={t.share}><Icon name="openmoji:outbox-tray" class="h-5 w-5" /></button>
          </div>
        )}
      </div>
    )}

    {variantStyle === 'featured' && (
      <div class="mt-6">
        <Button is="a" href={articleUrl} class="w-full">{t.read}</Button>
      </div>
    )}
  </div>
</article>